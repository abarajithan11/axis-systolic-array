name: Verify

on:
  push:

permissions:
  contents: read
  packages: write

env:
  GHCR_IMAGE: ghcr.io/${{ github.repository_owner }}/sa-ibex
  IMAGE_TAG: latest

jobs:
  build-and-push-image:
    runs-on: ubuntu-22.04

    outputs:
      docker_changed: ${{ steps.check-changes.outputs.docker_changed }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 

      - id: check-changes
        name: Detect Dockerfile / requirements changes
        shell: bash
        run: |
          set -e

          BEFORE="${{ github.event.before }}"
          SHA="${{ github.sha }}"

          # First push to branch (no "before" commit)? Force rebuild.
          if [ "$BEFORE" = "0000000000000000000000000000000000000000" ]; then
            echo "First push on this branch -> rebuild image"
            echo "docker_changed=true" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          echo "Diffing $BEFORE..$SHA"
          files="$(git diff --name-only "$BEFORE" "$SHA" || true)"
          echo "Changed files:"
          echo "$files"

          if echo "$files" | grep -E '^(Dockerfile|ibex-soc/python-requirements.txt|ibex-soc/vendor/google_riscv-dv/requirements.txt)$' >/dev/null; then
            echo "Docker image inputs changed -> rebuild"
            echo "docker_changed=true" >> "$GITHUB_OUTPUT"
          else
            echo "No Dockerfile/requirements changes -> reuse existing image"
            echo "docker_changed=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Log in to GHCR
        if: steps.check-changes.outputs.docker_changed == 'true'
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build Docker image via Makefile
        if: steps.check-changes.outputs.docker_changed == 'true'
        shell: bash
        run: |
          make IMAGE="${GHCR_IMAGE}:dev" image
          docker tag "${GHCR_IMAGE}:dev" "${GHCR_IMAGE}:${IMAGE_TAG}"

      - name: Push image to GHCR
        if: steps.check-changes.outputs.docker_changed == 'true'
        shell: bash
        run: docker push "${GHCR_IMAGE}:${IMAGE_TAG}"

  smoke-test-axi-subsystem:
    runs-on: ubuntu-22.04
    needs: build-and-push-image

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Pull CI image
        run: docker pull "${GHCR_IMAGE}:${IMAGE_TAG}"

      - name: Smoke test -- 5 AXI Ports with verilator
        run: |
          docker run --rm -v "$PWD":/repo -w /repo "${GHCR_IMAGE}:${IMAGE_TAG}" \
            make veri SYS=axi

  regress-axi-int:
    runs-on: ubuntu-22.04
    needs: smoke-test-axi-subsystem   # or needs: build-and-push-image if you don't want gating

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Pull CI image
        run: docker pull "${GHCR_IMAGE}:${IMAGE_TAG}"

      - name: Full Regression -- 2 AXI Ports
        run: |
          docker run --rm -v "$PWD":/repo -w /repo "${GHCR_IMAGE}:${IMAGE_TAG}" \
            make regress SYS=axi_int CLEAN_REGRESS=1

  regress-axi:
    runs-on: ubuntu-22.04
    needs: smoke-test-axi-subsystem

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Pull CI image
        run: docker pull "${GHCR_IMAGE}:${IMAGE_TAG}"

      - name: Full Regression -- 5 AXI Ports
        run: |
          docker run --rm \
            -v "$PWD":/repo \
            -w /repo \
            "${GHCR_IMAGE}:${IMAGE_TAG}" \
            make regress SYS=axi CLEAN_REGRESS=1

  smoke-test-ibex-soc:
    runs-on: ubuntu-22.04
    needs: smoke-test-axi-subsystem

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Pull CI image
        run: docker pull "${GHCR_IMAGE}:${IMAGE_TAG}"

      - name: Run Ibex SoC with verilator
        run: |
          docker run --rm -v "$PWD":/repo -w /repo "${GHCR_IMAGE}:${IMAGE_TAG}" \
            bash -lc '
              fusesoc library add sa_ip "$(pwd -P)" || true
              make ibuild irun
            '

  regress-ibex-soc:
    runs-on: ubuntu-22.04
    needs: smoke-test-ibex-soc

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Pull CI image
        run: docker pull "${GHCR_IMAGE}:${IMAGE_TAG}"

      - name: Regress Ibex SoC with verilator
        run: |
          docker run --rm \
            -v "$PWD":/repo \
            -w /repo \
            -e CMD="veri ibuild irun" \
            "${GHCR_IMAGE}:${IMAGE_TAG}" \
            bash -lc '
              fusesoc library add sa_ip "$(pwd -P)" || true
              make regress
            '

  
