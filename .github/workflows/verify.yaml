name: Verify

on:
  push:

permissions:
  contents: read
  packages: read   # needed to pull from GHCR with GITHUB_TOKEN

env:
  GHCR_IMAGE: ghcr.io/${{ github.repository_owner }}/sa-ibex
  IMAGE_TAG: latest   # image tag that build-image.yml pushes

jobs:
  # Quick sanity check
  smoke-verilator:
    runs-on: ubuntu-22.04

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Pull CI image
        run: docker pull "${GHCR_IMAGE}:${IMAGE_TAG}"

      - name: Smoke test -- 5 AXI Ports with verilator
        run: |
          docker run --rm -v "$PWD":/repo -w /repo "${IMAGE_NAME}:${IMAGE_TAG}" \
            make veri SYS=axi

  # Full regression: 2 AXI ports
  regress-axi-int:
    runs-on: ubuntu-22.04
    needs: smoke-verilator   # drop this if you want everything fully parallel

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Pull CI image
        run: docker pull "${GHCR_IMAGE}:${IMAGE_TAG}"

      - name: Full Regression -- 2 AXI Ports
        run: |
          docker run --rm -v "$PWD":/repo -w /repo "${IMAGE_NAME}:${IMAGE_TAG}" \
            make regress SYS=axi_int CLEAN_REGRESS=1

  # Full regression: 5 AXI ports
  regress-axi:
    runs-on: ubuntu-22.04
    needs: smoke-verilator   # or build directly on push by removing this

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Pull CI image
        run: docker pull "${GHCR_IMAGE}:${IMAGE_TAG}"

      - name: Full Regression -- 5 AXI Ports
        run: |
          docker run --rm -v "$PWD":/repo -w /repo "${IMAGE_NAME}:${IMAGE_TAG}" \
            make regress SYS=axi CLEAN_REGRESS=1

  # Ibex SoC run
  ibex-soc-verilator:
    runs-on: ubuntu-22.04
    needs: smoke-verilator   # can also depend on regress-* if you want

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Pull CI image
        run: docker pull "${GHCR_IMAGE}:${IMAGE_TAG}"

      - name: Run Ibex SoC with verilator
        run: |
          docker run --rm -v "$PWD":/repo -w /repo "${IMAGE_NAME}:${IMAGE_TAG}" \
            bash -lc '
              fusesoc library add sa_ip "$(pwd -P)" || true
              make ibuild
              make irun
            '
