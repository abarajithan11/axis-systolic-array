name: Verify
on: [push]

jobs:
  setup:
    runs-on: ubuntu-22.02
    steps:
      - uses: actions/checkout@v4

      - name: Base deps (toolchain, python, etc.)
        run: |
          sudo apt-get update
          sudo apt-get install -y git help2man perl python3 make autoconf g++ flex bison ccache \
              liblzma-dev libunwind-dev libgoogle-perftools-dev numactl libfl2 libfl-dev \
              libelf-dev srecord gcc-riscv64-unknown-elf
          python3 -m pip install --upgrade pip
          pip3 install --user -r ibex-soc/python-requirements.txt
          for t in g++ gcc ld objcopy objdump; do sudo ln -sf "$(command -v riscv64-unknown-elf-$t)" "/usr/local/bin/riscv32-unknown-elf-$t"; done

      - name: Install Verilator (prebuilt)
        run: |
          git clone https://github.com/abarajithan11/verilator-compiled
          cd verilator-compiled
          tar -C "$HOME" -xzf verilator.tar.gz
          "$HOME/verilator/bin/verilator" --version

      - name: Prime FuseSoC caches (optional but speeds up later)
        run: |
          echo "$HOME/verilator/bin" >> "$GITHUB_PATH"
          fusesoc --version || true
          fusesoc library add sa_ip "$(pwd -P)" || true

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: tooldeps
          path: |
            $HOME/verilator
            ~/.cache/fusesoc
            ~/.fusesoc
            ~/.config/fusesoc
          if-no-files-found: warn

  veri-axi:
    runs-on: ubuntu-22.02
    needs: setup
    steps:
      - uses: actions/checkout@v4
      - uses: actions/download-artifact@v4
        with: { name: tooldeps, path: $HOME }
      - run: echo "$HOME/verilator/bin" >> "$GITHUB_PATH"
      - run: make veri SYS=axi

  veri-axi-int:
    runs-on: ubuntu-22.02
    needs: setup
    steps:
      - uses: actions/checkout@v4
      - uses: actions/download-artifact@v4
        with: { name: tooldeps, path: $HOME }
      - run: echo "$HOME/verilator/bin" >> "$GITHUB_PATH"
      - run: make veri SYS=axi_int

  ibex-run:
    runs-on: ubuntu-22.02
    needs: setup
    steps:
      - uses: actions/checkout@v4
      - uses: actions/download-artifact@v4
        with: { name: tooldeps, path: $HOME }
      - run: echo "$HOME/verilator/bin" >> "$GITHUB_PATH"; fusesoc library add sa_ip "$(pwd -P)" || true
      - run: |
          make ibuild
          make irun
